<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-36037335-10');
</script>



<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.89.4" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">

<link rel="canonical" type="text/html" href="https://microshift.io/docs/user-documentation/how-tos/">
<link rel="apple-touch-icon" sizes="180x180" href="/images/logo/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/logo/favicon-16x16.png">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="mask-icon" href="images/logo/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#00aba9">
<meta name="theme-color" content="#ffffff">

<title>HowTos | MicroShift</title><meta property="og:title" content="HowTos" />
<meta property="og:description" content="Solving common use cases with MicroShift." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://microshift.io/docs/user-documentation/how-tos/" /><meta property="og:site_name" content="MicroShift" />

<meta itemprop="name" content="HowTos">
<meta itemprop="description" content="Solving common use cases with MicroShift."><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HowTos"/>
<meta name="twitter:description" content="Solving common use cases with MicroShift."/>





<link rel="preload" href="/scss/main.min.74383d8b2c66513431ce06d78f9cea3f5745dd97194594c5acd57ec8cc1c401c.css" as="style">
<link href="/scss/main.min.74383d8b2c66513431ce06d78f9cea3f5745dd97194594c5acd57ec8cc1c401c.css" rel="stylesheet" integrity="">


<script
  src="/js/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>





<meta name="theme-color" content="#326ce5">






<meta name="description" content="Solving common use cases with MicroShift.">
<meta property="og:description" content="Solving common use cases with MicroShift.">
<meta name="twitter:description" content="Solving common use cases with MicroShift.">
<meta property="og:url" content="https://microshift.io/docs/user-documentation/how-tos/">
<meta property="og:title" content="HowTos">
<meta name="twitter:title" content="HowTos">
<meta name="twitter:image" content="/images/favicon.png" />

<meta name="twitter:image:alt" content="MicroShift">

<meta property="og:image" content="/images/favicon.png">

<meta property="og:type" content="article">



<script src="/js/script.js"></script>




<link rel="stylesheet" href="/css/jquery-ui.min.137b1c829b79d35bbaea89c94a60a56165e443ca5dd258afed9f60317c44cc98.css">


  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark  flex-column flex-md-row td-navbar" data-auto-burger="primary">
        <a class="navbar-brand" href="/"></a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">

		<ul class="navbar-nav mt-2 mt-lg-0">
			
			<li class="nav-item mr-2 mb-lg-0">
				<a class="nav-link active" href="https://github.com/microshift-io/microshift" >Getting Started</span></a>
			</li>
			<li class="nav-item mr-2 mb-lg-0">
				<a class="nav-link active" href="https://github.com/microshift-io/microshift/blob/main/README.md" >Documentation</span></a>
			</li>
			
			
		</ul>
	</div>
	<button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/user-documentation/how-tos/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">HowTos</h1>
<div class="lead">Solving common use cases with MicroShift.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-c49e8fdeb5e48b453ab9c886672f7837">MicroShift with Advanced Cluster Management</a></li>


    
  
    
    
	
<li>2: <a href="#pg-067fcdf825875018d80f0acbac8fe3f0">Deploying MicroShift behind Proxy</a></li>


    
  
    
    
	
<li>3: <a href="#pg-bc46ef369ec8c5ad7e090b2e0a105779">Private registries and pull secrets</a></li>


    
  
    
    
	
<li>4: <a href="#pg-377f4900168fa9986825e624d7f6f4c4">Deploy a basic application</a></li>


    
  
    
    
	
<li>5: <a href="#pg-5fbbf9155094d477254e7a9708a94dfd">Dynamic Provisioning of PVs</a></li>


    
  
    
    
	
<li>6: <a href="#pg-7c8cb1c1a13c6df4a3f62a4c5665b735">Offline/disconnected container images</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c49e8fdeb5e48b453ab9c886672f7837">1 - MicroShift with Advanced Cluster Management</h1>
    <div class="lead">Manage the MicroShift cluster through Red Hat Advanced Cluster Management (RHACM).</div>
	<h2 id="microshift-with-advanced-cluster-management">MicroShift with Advanced Cluster Management</h2>
<p>Managing through RHACM (Red Hat Advanced Cluster Management) works just like for any other imported managed cluster (see [docs]). However, as secure production deployments don't provide any form of remote access to the cluster via ssh or kubectl, the recommended approach is to define a new cluster with ACM to get managed cluster credentials, then using your device (configuration) management agent of your choice to synchronise those credentials to the device and have MicroShift apply them automatically.</p>
<p>The feature of using RHACM to manage the lifecycle of applications running on MicroShift is only available for AMD64 based systems. Starting with RHACM 2.5, the management functionality of applications running on MicroShift will be available on ARM based architectures.</p>
<p>The steps below assume that RHACM has been installed on a cluster recognized as the hub cluster and that MicroShift is installed on a separate cluster referred to as the managed cluster.</p>
<h3 id="defining-the-managed-cluster-in-hub-cluster">Defining the managed cluster in hub cluster</h3>
<p>The following steps can be performed in the RHACM UI or on the CLI. On the RHACM hub cluster, run the following commands to define the MicroShift cluster as the managed cluster:</p>
<p>NOTE: Ensure you set the CLUSTER_NAME to a unique value that relates to the MicroShift cluster.</p>
<pre tabindex="0"><code>export CLUSTER_NAME=microshift

oc new-project ${CLUSTER_NAME}

oc label namespace ${CLUSTER_NAME} cluster.open-cluster-management.io/managedCluster=${CLUSTER_NAME}
</code></pre><p>Apply the following to define the managed MicroShift cluster.</p>
<pre tabindex="0"><code>cat &lt;&lt;EOF | oc apply -f -
apiVersion: agent.open-cluster-management.io/v1
kind: KlusterletAddonConfig
metadata:
  name: ${CLUSTER_NAME}
  namespace: ${CLUSTER_NAME}
spec:
  clusterName: ${CLUSTER_NAME}
  clusterNamespace: ${CLUSTER_NAME}
  applicationManager:
    enabled: true
  certPolicyController:
    enabled: true
  clusterLabels:
    cloud: auto-detect
    vendor: auto-detect
  iamPolicyController:
    enabled: true
  policyController:
    enabled: true
  searchCollector:
    enabled: true
EOF

cat &lt;&lt;EOF | oc apply -f -
apiVersion: cluster.open-cluster-management.io/v1
kind: ManagedCluster
metadata:
  name: ${CLUSTER_NAME}
spec:
  hubAcceptsClient: true
EOF

</code></pre><p>This will generate a secret named ${CLUSTER_NAME}-import in the ${CLUSTER_NAME} namespace. Extract the <code>import.yaml</code> and the <code>crds.yaml</code> which requires <code>yq</code> to be installed.</p>
<pre tabindex="0"><code>IMPORT=`oc get secret &quot;$CLUSTER_NAME&quot;-import -n &quot;$CLUSTER_NAME&quot; -o jsonpath={.data.import\\.yaml} | base64 --decode'`
IMPORT_KUBECONFIG=$(yq eval-all '. | select(.metadata.name == &quot;bootstrap-hub-kubeconfig&quot;) | .data.kubeconfig' IMPORT)
</code></pre><h3 id="importing-the-managed-microshift-cluster-to-hub-cluster">Importing the managed Microshift cluster to hub cluster</h3>
<p>The importing process can be done automatically by RHACM components running on the hub cluster once the following steps are performed on managed MicroShift cluster. A detailed explanation can be found in <a href="https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.4/html/clusters/managing-your-clusters#importing-the-cluster-manual">RHACM documentation</a>.</p>
<h4 id="prepare-the-manifests">Prepare the manifests</h4>
<p>A list of the K8s manifests based on <a href="https://kustomize.io/">Kustomize</a> can be found in <a href="https://github.com/redhat-et/microshift-documentation/content/en/docs/examples/manifests">this repo</a>. This repo contains more than manifests however we will only focus on the <code>manifests</code> folder. Before syncing the manifests to the MicroShift node, the following commands need to be run to render manifests:</p>
<pre tabindex="0"><code>sed -i &quot;s/{{ .clustername }}/${CLUSTER_NAME}/g&quot; manifests/klusterlet.yaml
sed -i &quot;s/{{ .kubeconfig }}/${IMPORT_KUBECONFIG}/g&quot; manifests/klusterlet-kubeconfighub.yaml
</code></pre><h4 id="sync-manifests-to-microshift-node">Sync manifests to MicroShift node</h4>
<p>The next step is to sync manifests to the MicroShift node. MicroShift has the feature of <a href="https://microshift.io/docs/user-documentation/manifests/">auto-applying manifests</a>. Once it finds a <code>kustomization.yaml</code> file in <code>${DATADIR}/manifests</code> (which defaults to <code>/var/lib/microshift/manifests</code>), <code>kubectl apply -k</code> will be run automatically upon start-up. The rendered manifests then need to be synced to <code>${DATADIR}/manifests</code>.</p>
<p>The syncing of manifests to managed Microshift cluster can be done by utilizing any GitOps tool to fetch the Kubernetes Kustomize manifests and put them in the directory described above, e.g. <a href="https://github.com/redhat-et/transmission">Transmission</a> tool can be used to pull updates and apply them transactionally on the ostree-based Linux operating systems.</p>
<h4 id="microshift-auto-applies-those-manifests-to-register-with-the-acm-cluster">MicroShift auto-applies those manifests to register with the ACM cluster</h4>
<p>The cluster now should have all add-ons enabled and be in a READY state within RHACM.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-067fcdf825875018d80f0acbac8fe3f0">2 - Deploying MicroShift behind Proxy</h1>
    <div class="lead">How to configure the host OS so MicroShift can work behind a proxy.</div>
	<p>When deploying MicroShift behind a proxy, configure the host OS to use the proxy for both yum and CRI-O.</p>
<h3 id="configuring-http-s-proxy-for-yum">Configuring HTTP(S) proxy for yum</h3>
<p>To configure yum to use a proxy, add the following to <code>/etc/yum.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#b8860b">proxy</span><span style="color:#666">=</span>http://<span style="color:#b8860b">$PROXY_SERVER</span>:<span style="color:#b8860b">$PROXY_SERVER</span>
<span style="color:#b8860b">proxy_username</span><span style="color:#666">=</span><span style="color:#b8860b">$PROXY_USER</span>
<span style="color:#b8860b">proxy_password</span><span style="color:#666">=</span><span style="color:#b8860b">$PROXY_PASSWORD</span>
</code></pre></div><h3 id="configuring-http-s-proxy-for-cri-o-or-podman">Configuring HTTP(S) proxy for CRI-O or Podman</h3>
<p>CRI-O and Podman are Go programs that use the built-in <code>net/http</code> package. To use an HTTP(S) proxy you need to set the <code>HTTP_PROXY</code> and <code>HTTPS_PROXY</code> environment variables and optionally the <code>NO_PROXY</code> variable to exclude a list of hosts from being proxied). For example, add the following to <code>/etc/systemd/system/crio.service.d/00-proxy.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#666">[</span>Service<span style="color:#666">]</span>
<span style="color:#b8860b">Environment</span><span style="color:#666">=</span><span style="color:#b8860b">NO_PROXY</span><span style="color:#666">=</span><span style="color:#b44">&#34;localhost,127.0.0.1,10.42.0.0/16,10.43.0.0/16&#34;</span>
<span style="color:#b8860b">Environment</span><span style="color:#666">=</span><span style="color:#b8860b">HTTP_PROXY</span><span style="color:#666">=</span><span style="color:#b44">&#34;http://</span><span style="color:#b8860b">$PROXY_USER</span><span style="color:#b44">:</span><span style="color:#b8860b">$PROXY_PASSWORD</span><span style="color:#b44">@</span><span style="color:#b8860b">$PROXY_SERVER</span><span style="color:#b44">:</span><span style="color:#b8860b">$PROXY_PORT</span><span style="color:#b44">/&#34;</span>
<span style="color:#b8860b">Environment</span><span style="color:#666">=</span><span style="color:#b8860b">HTTPS_PROXY</span><span style="color:#666">=</span><span style="color:#b44">&#34;http://</span><span style="color:#b8860b">$PROXY_USER</span><span style="color:#b44">:</span><span style="color:#b8860b">$PROXY_PASSWORD</span><span style="color:#b44">@</span><span style="color:#b8860b">$PROXY_SERVER</span><span style="color:#b44">:</span><span style="color:#b8860b">$PROXY_PORT</span><span style="color:#b44">/&#34;</span>
</code></pre></div><p>Restart CRI-O:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo systemctl restart crio
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bc46ef369ec8c5ad7e090b2e0a105779">3 - Private registries and pull secrets</h1>
    <div class="lead">MicroShift may need access to a private registry. Access can be granted from registry login or from a pull-secret.</div>
	<p>MicroShift may not have the pull secret for the registry that you are trying to use. For example, MicroShift does
not have the pull secret for <code>registry.redhat.io</code>. In order to use this registry, there are a few approaches.</p>
<h3 id="pulling-container-images-from-private-registries">Pulling Container Images From Private Registries</h3>
<h4 id="use-podman-to-authenticate-to-a-registry">Use Podman to Authenticate to a Registry</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">podman login registry.redhat.io
</code></pre></div><p>Once the podman login is complete, MicroShift will be able to pull images from this registry. This approach works across namespaces.</p>
<p>This approach assumes podman is installed. This might not be true for all MicroShift environments. For example,
if MicroShift is installed through RPM, CRI-O will be installed as a dependency, but not podman. In this case,
one can choose to install podman separately, or use other approaches described below.</p>
<h4 id="authenticate-to-a-registry-with-a-pull-secret">Authenticate to a Registry With a Pull-Secret</h4>
<p>The second approach is to create a pull secret, then let the service account use this pull secret. This approach works within a name space. For example, if the pull secret is stored in a json formatted file &quot;<strong>secret</strong>.json&quot;,</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># First create the secret in a name space</span>
oc create secret generic my_pull_secret <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --from-file<span style="color:#666">=</span>.dockerconfigjson<span style="color:#666">=</span>secret.json <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --type<span style="color:#666">=</span>kubernetes.io/dockerconfigjson
</code></pre></div><p>Alternatively, you can use your container manager configuration file to create the secret:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># First create the secret in a name space using our configuration file</span>
oc create secret generic my_pull_secret <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --from-file<span style="color:#666">=</span>.dockerconfigjson<span style="color:#666">=</span>.docker/config.json <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>    --type<span style="color:#666">=</span>kubernetes.io/dockerconfigjson
</code></pre></div><p>Finally, we set the secret as default for pulling</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># Then attach the secret to a service account in the name space</span>
oc secrets link default my_pull_secret --for<span style="color:#666">=</span>pull
</code></pre></div><p>Instead of attaching the secret to a service account, one can also specify the pull secret under the pod spec, Refer to <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">this Kubernetes document</a> for more details.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-377f4900168fa9986825e624d7f6f4c4">4 - Deploy a basic application</h1>
    <div class="lead">MicroShift operates similar to many other Kubernetes providers. This means that you can use the same tools to deploy and manage your applications.</div>
	<p>All of the standard Kubernetes management tools can be used to maintain and modify your MicroShift applications. Below we will show some examples using oc, kustomize, and helm to deploy and maintain applications.</p>
<h2 id="example-applications">Example Applications</h2>
<h3 id="metal-lb">Metal LB</h3>
<p>Metal LB is a load balancer that can be used to route traffic to a number of backends.</p>
<p>Creating the Metal LB namespace and deployment.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/namespace.yaml
oc apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/metallb.yaml
</code></pre></div><p>Once the components are available, a <code>ConfigMap</code> is required to define the address pool for the load balancer to use.</p>
<p>Create the Metal LB ConfigMap:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">oc create -f - &lt;&lt;EOF<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>metallb-system<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>config<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">data</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">config</span>:<span style="color:#bbb"> </span>|<span style="color:#b44;font-style:italic">
</span><span style="color:#b44;font-style:italic">    address-pools:
</span><span style="color:#b44;font-style:italic">    - name: default
</span><span style="color:#b44;font-style:italic">      protocol: layer2
</span><span style="color:#b44;font-style:italic">      addresses:
</span><span style="color:#b44;font-style:italic">      - 192.168.1.240-192.168.1.250</span><span style="color:#bbb">    
</span><span style="color:#bbb"></span>EOF<span style="color:#bbb">
</span></code></pre></div><p>Now we are able to deploy a test application to verify thing are working as expected.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc create ns <span style="color:#a2f">test</span>
oc create deployment nginx -n <span style="color:#a2f">test</span> --image nginx
</code></pre></div><p>Create a service:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">oc create -f - &lt;&lt;EOF<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>test<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">annotations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">metallb.universe.tf/address-pool</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">targetPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>LoadBalancer<span style="color:#bbb">
</span><span style="color:#bbb"></span>EOF<span style="color:#bbb">
</span></code></pre></div><p>Verify the service exists and that an IP address has been assigned.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">oc get svc -n <span style="color:#a2f">test</span>
NAME    TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span style="color:#666">(</span>S<span style="color:#666">)</span>        AGE
nginx   LoadBalancer   10.43.183.104   192.168.1.241   80:32434/TCP   29m
</code></pre></div><p>Using your browser you can now access the NGINX application by the <code>EXTERNAL-IP</code> provided by the service.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5fbbf9155094d477254e7a9708a94dfd">5 - Dynamic Provisioning of PVs</h1>
    <div class="lead">MicroShift storage solution can provision persistent volumes dynamically based on claims.</div>
	<p>MicroShift deploys the <a href="https://github.com/kubevirt/hostpath-provisioner">hostpath provisioner</a> as solution to provide persistent storage to pods. The hostpath provisioner pod mounts the <code>/var/hpvolumes</code> directory in order to provision volumes. It also has the ability to dynamically provision PVs when a PVC is created, and wait until a pod uses that specific PVC.</p>
<p>Let's see how to create a PVC so the hostpath provisioner creates the persistent volume for us.</p>
<h3 id="create-a-persistent-volume-claim">Create a Persistent Volume Claim</h3>
<p>MicroShift's hostpath provisioner creates a <code>StorageClass</code> named <code>kubevirt-hostpath-provisioner</code> by default.</p>
<p>The PVC manifest must reference this <code>StorageClass</code> using the <code>storageClassName</code> spec parameter and there should be an annotation pointing at the node where the PV is going to be created. <em>This annotation is crucial if we want dynamic provisioning of PVs</em>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>PersistentVolumeClaim<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>task-pv-claim<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">annotations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">kubevirt.io/provisionOnNode</span>:<span style="color:#bbb"> </span>ricky-fedora.oglok.net<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">storageClassName</span>:<span style="color:#bbb"> </span>kubevirt-hostpath-provisioner<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">accessModes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- ReadWriteOnce<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">storage</span>:<span style="color:#bbb"> </span>3Gi<span style="color:#bbb">
</span></code></pre></div><p>This manifest will create the following Persistent Volume Claim and a Persistent Volume located at <code>/var/hpvolumes/</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ oc get pvc
NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                    AGE
task-pv-claim   Bound    pvc-58a28c40-7726-4830-ba70-32d18188a8b4   39Gi       RWO            kubevirt-hostpath-provisioner   8m43s
$ oc get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                   STORAGECLASS                    REASON   AGE
pvc-58a28c40-7726-4830-ba70-32d18188a8b4   39Gi       RWO            Delete           Bound    default/task-pv-claim   kubevirt-hostpath-provisioner            8m43s

$ ll /var/hpvolumes/
total <span style="color:#666">0</span>
drwxrwxrwx. <span style="color:#666">1</span> root root <span style="color:#666">8</span> Apr  <span style="color:#666">5</span> 10:26 pvc-58a28c40-7726-4830-ba70-32d18188a8b4
</code></pre></div><p>For sake of clarity, we will instantiate a sample NGINX pod that mounts that volume:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>task-pv-pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>task-pv-storage<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">persistentVolumeClaim</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">claimName</span>:<span style="color:#bbb"> </span>task-pv-claim<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>task-pv-container<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#008000;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;http-server&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#008000;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;/usr/share/nginx/html&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>task-pv-storage<span style="color:#bbb">
</span></code></pre></div><p>Any HTML file located at <code>/var/hpvolumes/pvc-58a28c40-7726-4830-ba70-32d18188a8b4</code> can be exposed by the NGINX running in the pod using a regular service.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7c8cb1c1a13c6df4a3f62a4c5665b735">6 - Offline/disconnected container images</h1>
    <div class="lead">Offline containers are containers which are stored in the operating system image, and made available to <code>cri-o</code> via the <code>/etc/container/storage.conf</code> <code>additionalimagestores</code> list.</div>
	<h2 id="what-are-offline-container-images">What are offline container images</h2>
<p>Offline containers are containers which are stored in the operating, or
the operating system image for an ostree based system,
and made available to <code>cri-o</code> via the <code>/etc/container/storage.conf</code>
<code>additionalimagestores</code> list.</p>
<p>Those container images are accesible for <code>cri-o</code> to create containers. Those images
cannot be deleted, but newer versions of those containers can be downloaded normally,
which <code>cri-o</code> will store in the general R/W container storage of the system.</p>
<h2 id="when-to-use-offline-container-images">When to use offline container images</h2>
<p>Offline containers are useful when the edge device will have restricted connectivity,
or no connectivity at all. Those containers are also helpful to improve general MicroShift
and application startup on first boot, since no images need to be downloaded from the
network and the applications are readily available to <code>cri-o</code></p>
<h2 id="rpm-packaging-of-container-images">RPM packaging of container images</h2>
<p>RPM packaging of container images into read-only container storage is offered via the
<a href="https://github.com/openshift/microshift/blob/main/packaging/rpm/paack.py"><code>paack</code></a> tool
as an experimental method to allow users to create ostree images containing the desired containers.
<code>RPM</code> was not designed for storing files with numeric uids/gids, or containing extended attributes,
although several workarounds allow this we are looking for better ways to provide this.</p>
<h2 id="offline-microshift-containers-images">Offline MicroShift containers images</h2>
<p>MicroShift uses a set of containers for the minimal components which can be installed
on the operating system image, those are published <a href="https://copr.fedorainfracloud.org/coprs/g/redhat-et/microshift-containers/">here</a>, and can also be manually built using:  <code>packaging/rpm/make-microshift-images-rpm.sh</code>.</p>
<p>To install the MicroShift container images you can use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -L -o /etc/yum.repos.d/microshift-containers.repo <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>          https://copr.fedorainfracloud.org/coprs/g/redhat-et/microshift-containers/repo/fedora-35/group_redhat-et-microshift-containers-fedora-35.repo

rpm-ostree install microshift-containers
</code></pre></div><p>Or simply include this package when using image-builder.</p>
<h2 id="how-package-your-application-and-manifests-as-rpms-for-offline-container-storage">How package your application and manifests as rpms for offline container storage</h2>
<p>To package workload application container images we provide <code>packaging/rpm/paack.py</code>.
This tool accepts a yaml definition, for which an example can be found
<a href="https://github.com/openshift/microshift/blob/main/packaging/rpm/example-user-containers.yaml">here</a>.</p>
<p>The tool can produce an srpm, rpm, or push a build to a copr repository.</p>
<p>Some example usages:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./paack.py rpm example-user-containers.yaml centos-stream-9-aarch64
</code></pre></div><p>The target OS is not important (<code>centos-stream-9</code>) but we need one os target
compatible with the destination architecture.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./paack.py srpm example-user-containers.yaml
</code></pre></div><p>The produced <code>srpm</code> format contains the repository binaries and manifests for each architecture,
then the build system unpacks the specific architecture for the build. The post install step
of rpm configures the <code>additionalimagestores</code> in <code>/etc/container/storage.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./paack.py copr example-user-containers.yaml mangelajo/my-app-containers
</code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="d-print-none">
  <div class="footer__links">
    <nav>
      
      
      <a class="text-white" href="/docs/home/">Home</a>
      
      <a class="text-white" href="/docs/community/">Community</a>
      
    </nav>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-6 col-sm-2 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" href="https://twitter.com/microshift_io">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Calendar" aria-label="Calendar">
    <a class="text-white" target="_blank" href="https://calendar.google.com/calendar/embed?src=nj6l882mfe4d2g9nr1h7avgrcs%40group.calendar.google.com&amp;ctz=America%2FChicago">
      <i class="fas fa-calendar-alt"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Youtube" aria-label="Youtube">
    <a class="text-white" target="_blank" href="https://www.youtube.com/results?search_query=MicroShift&#43;Red&#43;Hat">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-2 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/openshift/microshift">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" href="https://microshift.slack.com">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-8 text-center order-sm-2">
        <small class="text-white">&copy; 2025 </small>
        
          
        
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="/js/popper-1.14.3.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="/js/bootstrap-4.3.1.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>











<script src="/js/main.min.d450479ebf922238b0349336733304a8093ef200121614f1214a9d106d3775d0.js" integrity="sha256-1FBHnr&#43;SIjiwNJM2czMEqAk&#43;8gASFhTxIUqdEG03ddA=" crossorigin="anonymous"></script>








<script type="text/javascript" src="/js/jquery-ui.min.c31ea7e64c1740bcef4b5af6b26f61e5b19ab33388395bc56d4ea49229c5b84d.js"></script>

<script>$( function() { $( ".tabs" ).tabs();} ); </script>
  </body>
</html>
